# ==============================================================================
# 训练增强配置（含训练优化、日志监控、评测、早停等辅助功能，适配全场景训练）
# 说明：补充核心训练参数之外的增强特性，平衡训练效率、显存占用与实验管理
# ==============================================================================

# ==============================================================================
# 训练基础增强配置（控制输出管理、数据处理优化）
# ==============================================================================

add_version: true  # 输出目录版本化：在output_dir下新增'<版本号>-<时间戳>'子目录
                   # 用途：防止多次训练权重覆盖，便于实验追溯
                   # 默认值：true

check_model: true  # 本地模型文件校验：检查模型文件是否损坏/修改并给出提示
                   # 注意：断网环境下需设为false（避免校验时触发网络请求）
                   # 默认值：true

create_checkpoint_symlink: false  #  checkpoint软链接创建：生成best/last模型快捷方式
                                  # 链接路径：f"{output_dir}/best"（最优模型）、f"{output_dir}/last"（最新模型）
                                  # 用途：简化自动化训练脚本的路径书写
                                  # 默认值：false

packing: false  # 数据打包优化：将不同长度样本打包为统一长度（提升GPU利用率）
                # 优势：
                # 1. 解决长文本拖慢训练速度的问题，实现负载均衡
                # 2. 使用flash_attn时，保证打包样本内序列互不可见
                # 支持场景：CPT/SFT/DPO/KTO/GKD
                # 注意：打包后样本数减少，需手动调整梯度累加数和学习率
                # 默认值：false

packing_length: null  # 打包目标长度（统一样本的token长度）
                      # 默认值：null（自动设为max_length）

packing_num_proc: 1  # 打包过程的并行进程数
                     # 注意：进程数不同会导致最终打包后的数据集不同；流式打包时该参数无效
                     # 默认值：1

lazy_tokenize: null  # 惰性分词开关：按需即时分词（而非预先生成所有token）
                     # 自动逻辑：
                     # - LLM训练默认false（预先生成分词，提升训练速度）
                     # - MLLM训练默认true（节约内存，避免预加载大量图像）
                     # 注意：需图像数据增强时，需设为true（或streaming=true），并修改Template.encode方法
                     # 默认值：null

use_logits_to_keep: null  # 无效logits过滤：通过logits_to_keep减少计算与存储
                          # 优势：降低显存占用、加快训练速度
                          # 默认值：null（自动根据模型/任务类型选择）

# ==============================================================================
# 训练评估与生成配置（控制验证时的评估逻辑、生成参数）
# ==============================================================================

acc_strategy: "token"  # 准确率计算策略（训练/验证时生效）
                       # 可选值："seq"（序列级准确率）、"token"（token级准确率）
                       # 默认值："token"

max_new_tokens: 64  # 验证生成最大token数（仅predict_with_generate=true时生效）
                    # 用途：覆盖默认生成参数，控制验证时的生成长度
                    # 默认值：64

temperature: 0.0  # 验证生成温度（仅predict_with_generate=true时生效）
                  # 用途：控制生成多样性（0=确定性生成，越高越随机）
                  # 默认值：0.0

# ==============================================================================
# 自定义插件配置（支持自定义优化器、损失函数、评估指标）
# ==============================================================================

optimizer: null  # 自定义优化器名称（通过plugin扩展）
                 # 可选值：参考ms-swift插件文档（https://swift.readthedocs.io/zh-cn/latest/Advanced/Plugin.html）
                 # 默认值：null（使用默认优化器）

loss_type: null  # 自定义损失函数名称（通过plugin扩展）
                 # 默认值：null（使用模型自带损失函数）

metric: null  # 自定义评估指标名称（通过plugin扩展）
              # 自动逻辑：predict_with_generate=true时默认设为"nlg"（自然语言生成指标）
              # 默认值：null

# ==============================================================================
# Evalscope 评测配置（训练时同步进行专业评测，需单独启用）
# ==============================================================================

eval_use_evalscope: false  # 是否启用Evalscope评测（训练过程中同步评测）
                           # 参考示例：https://swift.readthedocs.io/zh-cn/latest/Examples/Evalscope.html
                           # 默认值：false

eval_dataset: []  # 评测数据集列表（支持多个数据集，空格分隔）
                  # 示例：["cnn_dailymail", "super_glue"]
                  # 默认值：[]

eval_dataset_args: null  # 评测数据集参数（JSON格式，支持多数据集配置）
                         # 示例：'{"cnn_dailymail": {"split": "validation"}, "super_glue": {"tasks": ["mrpc"]}}'
                         # 默认值：null

eval_limit: null  # 评测数据集采样数（限制每个数据集的评测样本量）
                  # 默认值：null（使用全量样本）

eval_generation_config: '{"max_tokens": 512}'  # 评测时生成配置（JSON格式）
                                               # 示例：'{"max_tokens": 1024, "temperature": 0.7}'
                                               # 默认值：'{"max_tokens": 512}'

# ==============================================================================
# 训练稳定性与效率优化配置
# ==============================================================================

use_flash_ckpt: false  # 启用DLRover Flash Checkpoint（异步权重保存）
                       # 优势：权重先存共享内存，再异步持久化，提升训练效率
                       # 注意：
                       # 1. 暂不支持safetensors格式
                       # 2. 建议搭配环境变量PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"（避免OOM）
                       # 默认值：false

early_stop_interval: null  # 早停间隔（基于save_steps，需eval_steps与save_steps一致）
                           # 逻辑：连续early_stop_interval个周期内best_metric无提升则终止训练
                           # 扩展：复杂早停需求可覆盖callback.py中的实现
                           # 默认值：null（不启用早停）

# ==============================================================================
# SwanLab 监控配置（实验可视化、结果推送，需SwanLab账号）
# ==============================================================================

swanlab_token: null  # SwanLab API-Key（用于登录认证，获取地址：https://swanlab.cn/settings/api-keys）
                     # 默认值：null

swanlab_project: null  # SwanLab项目名称（需在SwanLab页面预先创建：https://swanlab.cn/space/~）
                       # 默认值：null

swanlab_workspace: null  # SwanLab工作空间名称
                         # 默认值：null（自动使用API-Key对应的用户名）

swanlab_exp_name: null  # 实验名称
                        # 默认值：null（自动使用output_dir的目录名）

swanlab_lark_webhook_url: null  # 飞书推送Webhook URL（用于实验结果推送）
                                # 默认值：null

swanlab_lark_secret: null  # 飞书推送密钥（用于验证Webhook请求）
                           # 默认值：null

swanlab_mode: "cloud"  # SwanLab运行模式
                       # 可选值："cloud"（云模式，数据存储在SwanLab云端）、"local"（本地模式，数据存储在本地）
                       # 默认值："cloud"